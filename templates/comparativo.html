{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="mb-0">Comparativo de Galerías</h2>
      {% if run_id and ejecuciones %}
        <a class="btn btn-primary" href="{{ url_for('detalle_ejecucion', ejecucion_id=ejecuciones[0].id) }}">
          Volver a corrida
        </a>
      {% endif %}
    </div>

    {% if not ejecuciones or ejecuciones|length == 0 %}
      <div class="alert alert-warning">
        No hay ejecuciones para comparar. Ejecuta una corrida e intenta de nuevo.
      </div>
    {% endif %}

    {# ====== TABLA  ====== #}
    <div class="card mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Tabla de datos (todas las métricas)</h5>
        <button class="btn btn-sm btn-outline-secondary" id="btnCsv">Descargar CSV</button>
      </div>

      <div class="card-body">
        {% if tabla_rows and tabla_rows|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm table-striped table-hover align-middle tabla-comparativo" id="tablaComparativo">
              <thead class="table-secondary sticky-header">
                <tr>
                  <th>Comuna</th>
                  
                  <th class="text-end">Fitness</th>
                  <th class="text-end">Inv. total</th>
                  <th class="text-end">Inv. locales</th>
                  <th class="text-end">Inv. parq.</th>
                  <th class="text-end">Inv. zonas</th>

                  <th class="text-end">Ing. total</th>
                  <th class="text-end">Egr. total</th>

                  <th class="text-end">Ing. arr.</th>
                  <th class="text-end">Ing. adm.</th>
                  <th class="text-end">Ing. parq.</th>

                  <th class="text-end">Egr. mant.</th>
                  <th class="text-end">Egr. serv.</th>
                  <th class="text-end">Egr. sal.</th>
                  <th class="text-end">Egr. ope.</th>
                  <th class="text-end">Egr. adm.</th>
                  <th class="text-end">Egr. leg.</th>
                  <th class="text-end">Egr. imp.</th>

                  <th class="text-end">Accesib.</th>
                  <th class="text-end">Emp. dir.</th>
                  <th class="text-end">Emp. ind.</th>
                  <th class="text-end">Calidad vida</th>

                  <th class="text-end">Ál. frescos</th>
                  <th class="text-end">Com. prep.</th>
                  <th class="text-end">No alim.</th>
                  <th class="text-end">Compl.</th>

                  <th class="text-end">Índice MUN</th>
                  <th class="text-end">B/C</th>
                  <th class="text-end">Benef. social</th>
                </tr>
              </thead>
              <tbody>
                {% for r in tabla_rows %}
                <tr>
                  <td>{{ r.label }}</td>
                  
                  <td class="text-end" data-order="{{ r.idx_fitness or 0 }}">{{ '{:,.3f}'.format(r.idx_fitness or 0) }}</td>
                  <td class="text-end" data-order="{{ r.inv_total or 0 }}">{{ '{:,.0f}'.format(r.inv_total or 0) }}</td>
                  <td class="text-end" data-order="{{ r.inv_loc   or 0 }}">{{ '{:,.0f}'.format(r.inv_loc   or 0) }}</td>
                  <td class="text-end" data-order="{{ r.inv_parq  or 0 }}">{{ '{:,.0f}'.format(r.inv_parq  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.inv_zonas or 0 }}">{{ '{:,.0f}'.format(r.inv_zonas or 0) }}</td>

                  <td class="text-end" data-order="{{ r.ing_total or 0 }}">{{ '{:,.0f}'.format(r.ing_total or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_total or 0 }}">{{ '{:,.0f}'.format(r.egr_total or 0) }}</td>

                  <td class="text-end" data-order="{{ r.ing_arr  or 0 }}">{{ '{:,.0f}'.format(r.ing_arr  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.ing_adm  or 0 }}">{{ '{:,.0f}'.format(r.ing_adm  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.ing_parq or 0 }}">{{ '{:,.0f}'.format(r.ing_parq or 0) }}</td>

                  <td class="text-end" data-order="{{ r.egr_mant or 0 }}">{{ '{:,.0f}'.format(r.egr_mant or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_serv or 0 }}">{{ '{:,.0f}'.format(r.egr_serv or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_sal  or 0 }}">{{ '{:,.0f}'.format(r.egr_sal  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_ope  or 0 }}">{{ '{:,.0f}'.format(r.egr_ope  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_adm  or 0 }}">{{ '{:,.0f}'.format(r.egr_adm  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_leg  or 0 }}">{{ '{:,.0f}'.format(r.egr_leg  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.egr_imp  or 0 }}">{{ '{:,.0f}'.format(r.egr_imp  or 0) }}</td>

                  <td class="text-end" data-order="{{ r.bs_acces   or 0 }}">{{ '{:,.0f}'.format(r.bs_acces   or 0) }}</td>
                  <td class="text-end" data-order="{{ r.bs_emp_dir or 0 }}">{{ '{:,.0f}'.format(r.bs_emp_dir or 0) }}</td>
                  <td class="text-end" data-order="{{ r.bs_emp_ind or 0 }}">{{ '{:,.0f}'.format(r.bs_emp_ind or 0) }}</td>
                  <td class="text-end" data-order="{{ r.bs_calidad or 0 }}">{{ '{:,.0f}'.format(r.bs_calidad or 0) }}</td>

                  <td class="text-end" data-order="{{ r.ar_af  or 0 }}">{{ '{:,.0f}'.format(r.ar_af  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.ar_cp  or 0 }}">{{ '{:,.0f}'.format(r.ar_cp  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.ar_nal or 0 }}">{{ '{:,.0f}'.format(r.ar_nal or 0) }}</td>
                  <td class="text-end" data-order="{{ r.ar_sc  or 0 }}">{{ '{:,.0f}'.format(r.ar_sc  or 0) }}</td>

                  <td class="text-end" data-order="{{ r.idx_mun or 0 }}">{{ '{:,.2f}'.format(r.idx_mun or 0) }}</td>
                  <td class="text-end" data-order="{{ r.idx_bc  or 0 }}">{{ '{:,.2f}'.format(r.idx_bc  or 0) }}</td>
                  <td class="text-end" data-order="{{ r.idx_bs_idx or 0 }}">{{ '{:,.2f}'.format(r.idx_bs_idx or 0) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info mb-0">No hay datos para mostrar en la tabla.</div>
        {% endif %}
      </div>
    </div>

    {# ====== ECONÓMICO ====== #}
    <div class="card mb-4">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">1. Beneficio Económico</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="border rounded p-3 chart-box">
              <h6 class="mb-2">1.1 Inversión inicial — total</h6>
              <canvas id="chartInvTotal"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded p-3 chart-box">
              <h6 class="mb-2">1.1.x Inversión — desglose</h6>
              <canvas id="chartInvDesglose"></canvas>
            </div>
          </div>

          <div class="col-md-6">
            <div class="border rounded p-3 chart-box">
              <h6 class="mb-2">1.2 / 1.3 — Ingresos vs Egresos (totales)</h6>
              <canvas id="chartIngEgrTotal"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded p-3 chart-box">
              <h6 class="mb-2">1.2.x Ingresos — desglose</h6>
              <canvas id="chartIngDesglose"></canvas>
            </div>
          </div>

          <div class="col-12">
            <div class="border rounded p-3 chart-box" style="height:360px">
              <h6 class="mb-2">1.3.x Egresos — desglose</h6>
              <canvas id="chartEgrDesglose"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== BENEFICIO SOCIAL ====== -->
    <div class="card mb-4">
      <div class="card-header bg-warning">
        <h5 class="mb-0">2. Beneficio Social</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-7">
            <div class="border rounded p-3" style="height:340px">
              <h6 class="mb-2">2.a Empleo (valores grandes)</h6>
              <canvas id="chartEmpleo"></canvas>
            </div>
          </div>
          <div class="col-md-5">
            <div class="border rounded p-3" style="height:340px">
              <h6 class="mb-2">2.b Accesibilidad &amp; Calidad de vida (decimales)</h6>
              <canvas id="chartAccCal"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>


    {# ====== ÁREAS COMERCIALES ====== #}
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">3. Áreas Comerciales</h5>
      </div>
      <div class="card-body">
        <div class="border rounded p-3 chart-box" style="height:340px">
          <canvas id="chartAreas"></canvas>
        </div>
      </div>
    </div>


    {# ====== ÍNDICES ====== #}
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">Índices (MUN, B/C, B/S)</h5>
      </div>
      <div class="card-body">
        <div class="border rounded p-3 chart-box">
          <canvas id="chartIndices"></canvas>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 justify-content-end">
      <a class="btn btn-outline-secondary" href="{{ url_for('historial') }}">Historial</a>
      {% if run_id and ejecuciones %}
        <a class="btn btn-primary" href="{{ url_for('detalle_ejecucion', ejecucion_id=ejecuciones[0].id) }}">
          Volver a corrida
        </a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- CSS propio para tabla y charts -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/comparativo-table.css') }}">

  <!-- Datos embebidos (antes de los scripts) -->
  <script id="cmp-data" type="application/json">
    {
      "labels": {{ labels|tojson|safe }},
      "be_inv_total": {{ be_inv_total|tojson|safe }},
      "be_inv_loc":   {{ be_inv_loc|tojson|safe }},
      "be_inv_parq":  {{ be_inv_parq|tojson|safe }},
      "be_inv_zonas": {{ be_inv_zonas|tojson|safe }},
      "be_ing_total": {{ be_ing_total|tojson|safe }},
      "be_ing_arr":   {{ be_ing_arr|tojson|safe }},
      "be_ing_adm":   {{ be_ing_adm|tojson|safe }},
      "be_ing_parq":  {{ be_ing_parq|tojson|safe }},
      "be_egr_total": {{ be_egr_total|tojson|safe }},
      "be_egr_mant":  {{ be_egr_mant|tojson|safe }},
      "be_egr_serv":  {{ be_egr_serv|tojson|safe }},
      "be_egr_sal":   {{ be_egr_sal|tojson|safe }},
      "be_egr_ope":   {{ be_egr_ope|tojson|safe }},
      "be_egr_adm":   {{ be_egr_adm|tojson|safe }},
      "be_egr_leg":   {{ be_egr_leg|tojson|safe }},
      "be_egr_imp":   {{ be_egr_imp|tojson|safe }},
      "bs_acces":     {{ bs_acces|tojson|safe }},
      "bs_emp_dir":   {{ bs_emp_dir|tojson|safe }},
      "bs_emp_ind":   {{ bs_emp_ind|tojson|safe }},
      "bs_calidad":   {{ bs_calidad|tojson|safe }},
      "ar_af":        {{ ar_af|tojson|safe }},
      "ar_cp":        {{ ar_cp|tojson|safe }},
      "ar_nal":       {{ ar_nal|tojson|safe }},
      "ar_sc":        {{ ar_sc|tojson|safe }},
      "idx_mun":      {{ idx_mun|tojson|safe }},
      "idx_bc":       {{ idx_bc|tojson|safe }},
      "idx_bs_idx":   {{ idx_bs_idx|tojson|safe }},
      "idx_fitness":  {{ idx_fitness|tojson|safe }}
    }
  </script>

  <!-- jQuery + DataTables (solo para ordenamiento; sin búsqueda ni paginación) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.6/datatables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-2.0.6/datatables.min.js" defer></script>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const $ = window.jQuery;
      if ($ && $.fn && $.fn.DataTable) {
        $('#tablaComparativo').DataTable({
          searching: false,
          paging: false,
          info: false,
          order: [],            // no orden inicial; permite que el usuario elija
          autoWidth: false,
          columnDefs: [
            { targets: '_all', className: 'align-middle' }
          ],
          language: {
            emptyTable: 'Sin datos',
            sortAscending:  ' — pulsar para ordenar ascendente',
            sortDescending: ' — pulsar para ordenar descendente'
          }
        });
      }
    });
  </script>

  <!-- === Exportar CSV (opcional) === -->
  <script>
    (function () {
      function toCsvRow(arr) {
        return arr.map(v => {
          if (v === null || v === undefined) return '';
          const s = String(v).replace(/"/g, '""');
          return `"${s}"`;
        }).join(',');
      }
      window.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('btnCsv');
        if (!btn) return;
        btn.addEventListener('click', function () {
          const table = document.getElementById('tablaComparativo');
          if (!table) return;
          const rows = [];
          const ths = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
          rows.push(toCsvRow(ths));
          table.querySelectorAll('tbody tr').forEach(tr => {
            const cols = Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
            rows.push(toCsvRow(cols));
          });
          const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'comparativo.csv';
          a.click();
          URL.revokeObjectURL(url);
        });
      });
    })();
  </script>

  <!-- Chart.js (con fallback local) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      if (!window.Chart) {
        console.warn('CDN de Chart.js no disponible, cargando fallback local…');
        var s = document.createElement('script');
        s.src = "{{ url_for('static', filename='vendor/chart.umd.min.js') }}";
        s.defer = true;
        s.onload = function(){ if (window.__cmpInit) window.__cmpInit(); };
        document.head.appendChild(s);
      }
    });
  </script>

  <!-- Tu script de gráficos -->
  <script src="{{ url_for('static', filename='js/comparativo.js') }}" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      if (window.Chart && window.__cmpInit) window.__cmpInit();
    });
  </script>
{% endblock %}
