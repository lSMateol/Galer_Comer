{% extends "base.html" %}
{% block content %}
<div class="row"><div class="col-12">

  {% if error %}
    <div class="alert alert-danger">
      <h4>Error</h4><p>{{ error }}</p>
      <a href="{{ url_for('historial') }}" class="btn btn-secondary mt-2">Volver</a>
    </div>
  {% else %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Resumen de Corrida</h2>
    {% if run_id %}<span class="badge text-bg-secondary">run_id: {{ run_id }}</span>{% endif %}
  </div>

  {% if params %}
  <div class="card mb-3">
    <div class="card-header"><h5>Parámetros</h5></div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2"><strong>population_size:</strong> {{ params.population_size }}</div>
        <div class="col-md-2"><strong>max_generations:</strong> {{ params.max_generations }}</div>
        <div class="col-md-2"><strong>elite_percentage:</strong> {{ params.elite_percentage }}</div>
        <div class="col-md-2"><strong>mutation_rate:</strong> {{ params.mutation_rate }}</div>
        <div class="col-md-2"><strong>sigma_factor:</strong> {{ params.sigma_factor }}</div>
        <div class="col-md-2"><strong>crossover_rate:</strong> {{ params.crossover_rate }}</div>
      </div>
      {% if params.weights %}
      <div class="mt-2"><strong>weights (BE, BS, MUN):</strong> {{ params.weights }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="alert alert-info d-flex align-items-center justify-content-between">
    <div>
      <strong>Estado:</strong>
      {% if completa %} corrida completada ({{ ejecuciones|length }}/7){% else %} en ejecución ({{ ejecuciones|length }}/7){% endif %}
      {% if mejor_comuna %} — <strong>Mejor comuna base:</strong> {{ mejor_comuna }} (ROI {{ "%.2f"|format(mejor_roi or 0) }}%){% endif %}
    </div>
    <div>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('historial') }}">Ver historial</a>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-dark text-white"><h5>Galerías</h5></div>
    <div class="card-body table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Galería</th>
            <th>ROI %</th>
            <th>Utilidad Neta</th>
            <th>Inversión Inicial</th>
            <th>Margen</th>
            <th>Empleos</th>
            <th>Beneficio Social</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for e in ejecuciones %}
          <tr class="{% if e.comuna == 7 %}table-primary{% endif %}">
            <td>{% if e.comuna == 7 %}7 (Nueva){% else %}{{ e.comuna }}{% endif %}</td>
            <td>{{ "%.2f"|format(e.roi or 0) }}</td>
            <td>$ {{ "{:,.2f}".format(e.utilidad_neta_usd or 0) }}</td>
            <td>$ {{ "{:,.2f}".format(e.inv_inicial_usd or 0) }}</td>
            <td>{{ "{:.2%}".format(e.margen_utilidad or 0) }}</td>
            <td>{{ e.empleos_directos or 0 }}</td>
            <td>{{ "{:.4f}".format(e.beneficio_social or 0) }}</td>
            <td class="d-flex gap-2">
                <a href="{{ url_for('detalle_ejecucion', ejecucion_id=e.id) }}" class="btn btn-sm btn-outline-primary">Detalle</a>
                <a href="{{ url_for('corrida', run_id=e.run_id) }}" class="btn btn-sm btn-outline-secondary">Corrida</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="text-muted mb-0"><small>La fila resaltada es la galería 7 optimizada en la mejor comuna.</small></p>
    </div>
  </div>

  {% endif %}

</div></div>
{% endblock %}
